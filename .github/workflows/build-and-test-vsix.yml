name: Build and Test VSIX Extension

on:
  push:
    branches: [ main, master ]
    paths:
      - 'oci-devops/**'
      - 'common/**'
      - '.github/workflows/build-and-test-vsix.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'oci-devops/**'
      - 'common/**'
      - '.github/workflows/build-and-test-vsix.yml'
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for committing and pushing VSIX file
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          common/node_modules
          oci-devops/node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install dependencies
      run: |
        npm install
        cd common && npm install
        cd ../oci-devops && npm install

    - name: Build common package
      run: |
        cd common && npm run build

    - name: Build VSIX extension
      run: |
        cd oci-devops && npm run build
      continue-on-error: false

    - name: Verify VSIX was created
      run: |
        if [ ! -f oci-devops/oci-devops-*.vsix ]; then
          echo "Error: VSIX file was not created"
          exit 1
        fi
        ls -lh oci-devops/*.vsix
        echo "VSIX file created successfully"

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Test Docker build with Node.js Dockerfile
      run: |
        # Create a test Node.js project
        mkdir -p /tmp/test-nodejs-app
        cd /tmp/test-nodejs-app
        
        # Create a test package.json with invalid name (to test the fix)
        cat > package.json << 'EOF'
        {
          "name": "test api for cars",
          "version": "1.0.0",
          "description": "Test Node.js application",
          "main": "index.js",
          "scripts": {
            "start": "node index.js"
          },
          "dependencies": {
            "express": "^4.18.1"
          }
        }
        EOF
        
        # Create a simple index.js
        cat > index.js << 'EOF'
        const express = require('express');
        const app = express();
        const port = 3000;
        
        app.get('/', (req, res) => {
          res.send('Hello World!');
        });
        
        app.listen(port, () => {
          console.log(`Server running on port ${port}`);
        });
        EOF
        
        # Use the actual Dockerfile template from the extension (simplified for testing)
        # Extract the key parts we want to test
        cat > Dockerfile.test << 'DOCKERFILE_EOF'
        FROM container-registry.oracle.com/os/oraclelinux:8-slim AS builder
        
        ARG NODE_VERSION=20
        RUN microdnf install -y nodejs npm && \
            microdnf clean all
        
        WORKDIR /app
        
        # Copy package files
        COPY package*.json ./
        
        # Remove package-lock.json if it exists
        RUN rm -f package-lock.json || true
        
        # Validate and fix package.json if needed
        RUN node -e " \
          try { \
            const fs = require('fs'); \
            const pkgPath = 'package.json'; \
            if (!fs.existsSync(pkgPath)) { \
              console.error('package.json not found'); \
              process.exit(1); \
            } \
            const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8')); \
            if (pkg.name) { \
              const oldName = pkg.name; \
              const isValid = /^[a-z0-9._-]+$/.test(pkg.name.toLowerCase()); \
              if (!isValid) { \
                pkg.name = pkg.name.toLowerCase() \
                  .replace(/[^a-z0-9._-]/g, '-') \
                  .replace(/^-+|-+$/g, '') \
                  .replace(/\.{2,}/g, '.') \
                  .substring(0, 214); \
                if (!pkg.name) pkg.name = 'app'; \
                console.log('Fixed invalid package name: \"' + oldName + '\" -> \"' + pkg.name + '\"'); \
                fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2) + '\n'); \
              } \
            } \
          } catch (e) { \
            console.error('Error fixing package.json:', e.message); \
            process.exit(1); \
          } \
        "
        
        # Install dependencies
        RUN npm install --no-audit --no-fund
        
        # Copy application files
        COPY . .
        
        # Fix package.json again in case COPY overwrote it
        RUN node -e " \
          try { \
            const fs = require('fs'); \
            const pkgPath = 'package.json'; \
            if (fs.existsSync(pkgPath)) { \
              const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8')); \
              if (pkg.name) { \
                const oldName = pkg.name; \
                const isValid = /^[a-z0-9._-]+$/.test(pkg.name.toLowerCase()); \
                if (!isValid) { \
                  pkg.name = pkg.name.toLowerCase() \
                    .replace(/[^a-z0-9._-]/g, '-') \
                    .replace(/^-+|-+$/g, '') \
                    .replace(/\.{2,}/g, '.') \
                    .substring(0, 214); \
                  if (!pkg.name) pkg.name = 'app'; \
                  console.log('Fixed invalid package name after COPY: \"' + oldName + '\" -> \"' + pkg.name + '\"'); \
                  fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2) + '\n'); \
                } \
              } \
            } \
          } catch (e) { \
            console.error('Error fixing package.json after COPY:', e.message); \
            process.exit(1); \
          } \
        "
        
        # Build application (only if build script exists)
        RUN HAS_BUILD=$(node -p "try{require('./package.json').scripts.build?'yes':'no'}catch(e){'no'}") && \
            if [ "$HAS_BUILD" = "yes" ]; then \
              echo "Build script found, running npm run build"; \
              npm run build; \
            else \
              echo "No build script found in package.json, skipping build step"; \
            fi
        
        # Runtime stage
        FROM container-registry.oracle.com/os/oraclelinux:8-slim
        
        ARG NODE_VERSION=20
        RUN microdnf install -y nodejs npm && \
            microdnf clean all
        
        WORKDIR /app
        
        # Copy package files from builder stage
        COPY --from=builder /app/package*.json ./
        
        # Install production dependencies only
        RUN npm install --production --no-audit --no-fund
        
        # Copy built application from builder stage
        COPY --from=builder /app ./
        
        EXPOSE 3000
        
        CMD ["node", "index.js"]
        DOCKERFILE_EOF
        
        # Test Docker build
        echo "Testing Docker build with invalid package name..."
        docker build -f Dockerfile.test -t test-nodejs-app:latest . 2>&1 | tee /tmp/docker-build.log
        
        # Verify the image was created
        if docker images | grep -q test-nodejs-app; then
          echo "âœ… Docker build test passed - image created successfully"
          docker images | grep test-nodejs-app
        else
          echo "âŒ Docker build test failed - image not created"
          cat /tmp/docker-build.log
          exit 1
        fi
        
        # Verify package name was fixed in the build log
        if grep -q "Fixed invalid package name" /tmp/docker-build.log; then
          echo "âœ… Package name fix verified in build log"
        else
          echo "âš ï¸  Package name fix not found in build log (may not have been needed)"
        fi
        
        echo "Docker build test completed successfully"

    - name: Upload VSIX artifact
      uses: actions/upload-artifact@v4
      with:
        name: oci-devops-vsix
        path: oci-devops/oci-devops-*.vsix
        retention-days: 30

    - name: Commit and push VSIX (if on main/master)
      if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Find VSIX file
        VSIX_FILE=$(ls oci-devops/oci-devops-*.vsix 2>/dev/null | head -1)
        
        if [ -z "$VSIX_FILE" ]; then
          echo "No VSIX file found to commit"
          exit 0
        fi
        
        # Check if VSIX file is tracked and has changes
        if git ls-files --error-unmatch "$VSIX_FILE" >/dev/null 2>&1; then
          # File is tracked, check if it changed
          if ! git diff --quiet "$VSIX_FILE"; then
            echo "VSIX file has changes, committing..."
            git add "$VSIX_FILE"
            git commit -m "chore: update VSIX build [skip ci]" || echo "Commit failed or no changes"
            git push || echo "Push failed or nothing to push"
          else
            echo "VSIX file has no changes"
          fi
        else
          # File is not tracked, add it
          echo "VSIX file is new, adding and committing..."
          git add "$VSIX_FILE"
          git commit -m "chore: add VSIX build artifact [skip ci]" || echo "Commit failed"
          git push || echo "Push failed"
        fi

    - name: Summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… VSIX extension built successfully" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Docker build test passed" >> $GITHUB_STEP_SUMMARY
        if [ -f oci-devops/oci-devops-*.vsix ]; then
          VSIX_SIZE=$(ls -lh oci-devops/oci-devops-*.vsix | awk '{print $5}')
          echo "- ðŸ“¦ VSIX size: $VSIX_SIZE" >> $GITHUB_STEP_SUMMARY
        fi
